<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BudgetValue.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">OpenNARS</a> &gt; <a href="index.source.html" class="el_package">org.opennars.entity</a> &gt; <span class="el_source">BudgetValue.java</span></div><h1>BudgetValue.java</h1><pre class="source lang-java linenums">/* 
 * The MIT License
 *
 * Copyright 2018 The OpenNARS authors.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */
package org.opennars.entity;

import org.opennars.inference.BudgetFunctions;
import org.opennars.io.Symbols;
import org.opennars.io.Texts;

import java.io.Serializable;

import static org.opennars.inference.UtilityFunctions.*;
import org.opennars.main.Parameters;
/**
 * A triple of priority (current), durability (decay), and quality (long-term average).
 *
 * @author Pei Wang
 * @author Patrick Hammer
 */
public class BudgetValue implements Cloneable, Serializable {

    /** character that marks the two ends of a budget value */
    private static final char MARK = Symbols.BUDGET_VALUE_MARK;
    /** character that separates the factors in a budget value */
    private static final char SEPARATOR = Symbols.VALUE_SEPARATOR;
   
    
    /** relative share of time resource to be allocated */
    private float priority;
    
    /**
     * The percent of priority to be kept in a constant period; All priority
     * values &quot;decay&quot; over time, though at different rates. Each item is given a
     * &quot;durability&quot; factor in (0, 1) to specify the percentage of priority level
     * left after each reevaluation
     */
    private float durability;
    
    /** overall (context-independent) evaluation */
    private float quality;

    /** time at which this budget was last forgotten, for calculating accurate memory decay rates */
<span class="fc" id="L63">    private long lastForgetTime = -1;</span>
    
    private Parameters narParameters;
    public BudgetValue(final float p, final float d, final TruthValue qualityFromTruth, Parameters narParameters) {
<span class="fc" id="L67">        this(p, d, BudgetFunctions.truthToQuality(qualityFromTruth), narParameters);</span>
<span class="fc" id="L68">    }</span>


    /** 
     * Constructor with initialization
     * @param p Initial priority
     * @param d Initial durability
     * @param q Initial quality
     */
<span class="fc" id="L77">    public BudgetValue(final float p, final float d, final float q, Parameters narParameters) {</span>
<span class="fc" id="L78">        this.narParameters = narParameters;</span>
<span class="fc" id="L79">        priority = p;</span>
<span class="fc" id="L80">        durability = d;</span>
<span class="fc" id="L81">        quality = q;</span>
        
<span class="fc bfc" id="L83" title="All 2 branches covered.">        if(d&gt;=1.0) {</span>
<span class="fc" id="L84">            durability=(float) (1.0-narParameters.TRUTH_EPSILON);</span>
            //throw new IllegalStateException(&quot;durability value above or equal 1&quot;);
        }
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">        if(p&gt;1.0) {</span>
<span class="nc" id="L88">            priority=1.0f;</span>
            //throw new IllegalStateException(&quot;priority value above 1&quot;);
        }
<span class="fc" id="L91">    }</span>

    /**
     * Cloning constructor
     * @param v Budget value to be cloned
     */
    public BudgetValue(final BudgetValue v) {
<span class="nc" id="L98">        this(v.getPriority(), v.getDurability(), v.getQuality(), v.narParameters);</span>
<span class="nc" id="L99">    }</span>

    /**
     * Cloning method
     */
    @Override
    public BudgetValue clone() {
<span class="fc" id="L106">        return new BudgetValue(this.getPriority(), this.getDurability(), this.getQuality(), this.narParameters);</span>
    }

    /**
     * Get priority value
     * @return The current priority
     */
    public float getPriority() {
<span class="fc" id="L114">        return priority;</span>
    }

    /**
     * Change priority value
     * @param v The new priority
     */
    public final void setPriority(final float v) {
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">        if(v&gt;1.0f) {</span>
<span class="nc" id="L123">            throw new IllegalStateException(&quot;Priority &gt; 1.0: &quot; + v);</span>
            //v=1.0f;
        }
<span class="fc" id="L126">        priority = v;</span>
<span class="fc" id="L127">    }</span>

    /**
     * Increase priority value by a percentage of the remaining range
     * @param v The increasing percent
     */
    public void incPriority(final float v) {        
<span class="fc" id="L134">        setPriority( (float) Math.min(1.0, or(priority, v)));</span>
<span class="fc" id="L135">    }</span>

    /** AND's (multiplies) priority with another value */
    public void andPriority(final float v) {
<span class="nc" id="L139">        setPriority( (float)and(priority, v) );</span>
<span class="nc" id="L140">    }</span>

    /**
     * Decrease priority value by a percentage of the remaining range
     * @param v The decreasing percent
     */
    public void decPriority(final float v) {
<span class="fc" id="L147">        setPriority( (float)and(priority, v) );</span>
<span class="fc" id="L148">    }</span>

    /**
     * Get durability value
     * @return The current durability
     */
    public float getDurability() {
<span class="fc" id="L155">        return durability;</span>
    }

    /**
     * Change durability value
     * @param d The new durability
     */
    public void setDurability(float d) {
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">        if(d&gt;=1.0f) {</span>
<span class="nc" id="L164">            d=1.0f-this.narParameters.TRUTH_EPSILON;</span>
        }
<span class="fc" id="L166">        durability = d;</span>
<span class="fc" id="L167">    }</span>

    /**
     * Increase durability value by a percentage of the remaining range
     * @param v The increasing percent
     */
    public void incDurability(final float v) {
<span class="fc" id="L174">        float durability2 = or(durability, v);</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">        if(durability2&gt;=1.0f) {</span>
<span class="fc" id="L176">            durability2=1.0f-this.narParameters.TRUTH_EPSILON; //put into allowed range</span>
        }
<span class="fc" id="L178">        durability=durability2;</span>
<span class="fc" id="L179">    }</span>

    /**
     * Decrease durability value by a percentage of the remaining range
     * @param v The decreasing percent
     */
    public void decDurability(final float v) {
<span class="fc" id="L186">        durability = (float)and(durability, v);</span>
<span class="fc" id="L187">    }</span>

    /**
     * Get quality value
     * @return The current quality
     */
    public float getQuality() {
<span class="fc" id="L194">        return quality;</span>
    }

    /**
     * Change quality value
     * @param v The new quality
     */
    public void setQuality(final float v) {
<span class="fc" id="L202">        quality = v;</span>
<span class="fc" id="L203">    }</span>

    /**
     * Increase quality value by a percentage of the remaining range
     * @param v The increasing percent
     */
    public void incQuality(final float v) {
<span class="nc" id="L210">        quality = or(quality, v);</span>
<span class="nc" id="L211">    }</span>

    /**
     * Decrease quality value by a percentage of the remaining range
     * @param v The decreasing percent
     */
    public void decQuality(final float v) {
<span class="nc" id="L218">        quality = (float)and(quality, v);</span>
<span class="nc" id="L219">    }</span>

    /**
     * Merge one BudgetValue into another
     * @param that The other Budget
     */
    public void merge(final BudgetValue that) {
<span class="fc" id="L226">        BudgetFunctions.merge(this, that);</span>
<span class="fc" id="L227">    }</span>
    
    /**
     * @param rhs compared truth value
     * @return if this budget is greater in all quantities than another budget,
     */
    // used to prevent a merge that would have no consequence
    public boolean greaterThan(final BudgetValue rhs) {
<span class="nc bnc" id="L235" title="All 2 branches missed.">        return (getPriority() - rhs.getPriority() &gt; this.narParameters.BUDGET_THRESHOLD) &amp;&amp;</span>
<span class="nc bnc" id="L236" title="All 2 branches missed.">                (getDurability()- rhs.getDurability()&gt; this.narParameters.BUDGET_THRESHOLD) &amp;&amp;</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">                (getQuality() - rhs.getQuality() &gt; this.narParameters.BUDGET_THRESHOLD);</span>
    }

    
    /**
     * To summarize a BudgetValue into a single number in [0, 1]
     * @return The summary value
     */
    public float summary() {
<span class="fc" id="L246">        return aveGeo(priority, durability, quality);</span>
    }

    
    public boolean equalsByPrecision(final Object that) { 
<span class="nc bnc" id="L251" title="All 2 branches missed.">        if (that instanceof BudgetValue) {</span>
<span class="nc" id="L252">            final BudgetValue t = ((BudgetValue) that);</span>
<span class="nc" id="L253">            final float dPrio = Math.abs(getPriority() - t.getPriority());</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            if (dPrio &gt;= this.narParameters.TRUTH_EPSILON) return false;</span>
<span class="nc" id="L255">            final float dDura = Math.abs(getDurability() - t.getDurability());</span>
<span class="nc bnc" id="L256" title="All 2 branches missed.">            if (dDura &gt;= this.narParameters.TRUTH_EPSILON) return false;</span>
<span class="nc" id="L257">            final float dQual = Math.abs(getQuality() - t.getQuality());</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">            return dQual &lt; this.narParameters.TRUTH_EPSILON;</span>
        }
<span class="nc" id="L260">        return false;</span>
    }

    
    /**
     * Whether the budget should get any processing at all
     * &lt;p&gt;
     * to be revised to depend on how busy the system is
     * @return The decision on whether to process the Item
     */
    public boolean aboveThreshold() {
<span class="fc bfc" id="L271" title="All 2 branches covered.">        return (summary() &gt;= this.narParameters.BUDGET_THRESHOLD);</span>
    }

    /**
     * Fully display the BudgetValue
     * @return String representation of the value
     */
    @Override
    public String toString() {
<span class="fc" id="L280">        return MARK + Texts.n4(priority) + SEPARATOR + Texts.n4(durability) + SEPARATOR + Texts.n4(quality) + MARK;</span>
    }

    /**
     * Briefly display the BudgetValue
     * @return String representation of the value with 2-digit accuracy
     */
    public String toStringExternal() {
        //return MARK + priority.toStringBrief() + SEPARATOR + durability.toStringBrief() + SEPARATOR + quality.toStringBrief() + MARK;

<span class="fc" id="L290">        final CharSequence priorityString = Texts.n2(priority);</span>
<span class="fc" id="L291">        final CharSequence durabilityString = Texts.n2(durability);</span>
<span class="fc" id="L292">        final CharSequence qualityString = Texts.n2(quality);</span>
<span class="fc" id="L293">        return new StringBuilder(1 + priorityString.length() + 1 + durabilityString.length() + 1 + qualityString.length() + 1)</span>
<span class="fc" id="L294">            .append(MARK)</span>
<span class="fc" id="L295">            .append(priorityString).append(SEPARATOR)</span>
<span class="fc" id="L296">            .append(durabilityString).append(SEPARATOR)</span>
<span class="fc" id="L297">            .append(qualityString)</span>
<span class="fc" id="L298">            .append(MARK)</span>
<span class="fc" id="L299">            .toString();                </span>
    }

    /**
     * computes the period and sets the current time to the period
     *
     * @return period in time: currentTime - lastForgetTime
     */
    // TODO&lt; split this into two methods &gt;
    public long setLastForgetTime(final long currentTime) {
        final long period;
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (this.lastForgetTime == -1)            </span>
<span class="nc" id="L311">            period = 0;</span>
        else
<span class="nc" id="L313">            period = currentTime - lastForgetTime;</span>
        
<span class="nc" id="L315">        lastForgetTime = currentTime;</span>
        
<span class="nc" id="L317">        return period;</span>
    }

    public long getLastForgetTime() {
<span class="nc" id="L321">        return lastForgetTime;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>